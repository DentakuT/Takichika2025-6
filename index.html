<script>
// ページの読み込みが完了したときに実行
document.addEventListener('DOMContentLoaded', () => {
    // 更新日を表示
    try {
        const lastModified = new Date(document.lastModified);
        document.getElementById('last-updated').textContent = lastModified.toLocaleDateString('ja-JP', {
            year: 'numeric', month: 'long', day: 'numeric'
        });
    } catch (e) {
        document.getElementById('last-updated').textContent = '不明';
    }
    
    // 順位表を生成
    generateRankings();
});

/**
 * データを非同期で取得して順位表を作成する関数
 * data.txtの各行は "名前:前回レート:今回レート" の形式を想定しています。
 */
async function generateRankings() {
    const tableBody = document.getElementById("rankings-body");
    const dataFile = "data.txt";

    // 読み込み中の表示
    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">読み込み中...</td></tr>';

    try {
        const response = await fetch(dataFile);
        if (!response.ok) {
            throw new Error(`ファイルが見つかりません (HTTP ${response.status})`);
        }
        const data = await response.text();
        
        // 取得したデータを処理
        const players = data
            .trim()
            .split('\n')
            .filter(line => line.trim() !== '') // 空行を無視する
            .map(line => {
                const parts = line.split(':');
                
                // データ形式が "名前:前回レート:今回レート" でない行はスキップ
                if (parts.length !== 3) {
                    console.warn('不正な形式の行をスキップしました:', line);
                    return null; 
                }

                const name = parts[0].trim();
                // 1番目のコロンの後が「前回レート」
                const previousRate = parseInt(parts[1], 10);
                // 2番目のコロンの後が「今回レート」
                const currentRate = parseInt(parts[2], 10);

                // レートが数値でない場合はスキップ
                if (isNaN(previousRate) || isNaN(currentRate)) {
                    console.warn('レートが数値でない行をスキップしました:', line);
                    return null;
                }

                return {
                    name: name,
                    // 「レート」列には "今回レート" を表示
                    rate: currentRate,
                    // 「増減」列には "今回レート - 前回レート" を計算して表示
                    change: currentRate - previousRate
                };
            })
            .filter(player => player !== null); // 不正なデータ(null)を除外

        // レートで降順にソート
        players.sort((a, b) => b.rate - a.rate);

        // 読み込み中表示をクリア
        tableBody.innerHTML = '';
        
        if (players.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">表示するデータがありません。</td></tr>';
            return;
        }

        // テーブルに行を追加
        players.forEach((player, index) => {
            const rank = index + 1;
            const row = tableBody.insertRow();
            
            row.insertCell(0).textContent = rank;
            row.insertCell(1).textContent = player.name;
            row.insertCell(2).textContent = player.rate; // レート（今回レート）
            
            const changeCell = row.insertCell(3);
            let changeText = player.change;
            if (player.change > 0) {
                changeText = `+${player.change}`;
                changeCell.className = 'rate-plus';

            } else if (player.change < 0) {
                changeCell.className = 'rate-minus';

            } else {
                changeCell.className = 'rate-zero';
            }
            changeCell.textContent = changeText;
        });

    } catch (error) {
        console.error("順位表の生成中にエラーが発生しました:", error);
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">エラー: ${error.message}</td></tr>`;
    }
}
</script>
